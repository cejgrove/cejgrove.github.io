<!DOCTYPE html>
<html  >
<head>
        	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G8YXQGXPX5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-G8YXQGXPX5');
</script>
  <!-- Site made with Mobirise Website Builder v5.9.18, https://mobirise.com -->
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Mobirise v5.9.18, mobirise.com">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" href="assets/images/cwg-icon.png" type="image/x-icon">
  <meta name="description" content="Testing the accuracy of TFL's bus arrival time projections with traffic awareness">
  
  
  <title>Predicting Bus Arrival Times</title>
  <link rel="stylesheet" href="assets/web/assets/mobirise-icons2/mobirise2.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="assets/dropdown/css/style.css">
  <link rel="stylesheet" href="assets/theme/css/style.css">
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Inter+Tight:100,200,300,400,500,600,700,800,900,100i,200i,300i,400i,500i,600i,700i,800i,900i&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter+Tight:100,200,300,400,500,600,700,800,900,100i,200i,300i,400i,500i,600i,700i,800i,900i&display=swap"></noscript>
  <link rel="preload" as="style" href="assets/mobirise/css/mbr-additional.css?v=0AAY5w"><link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css?v=0AAY5w" type="text/css">

  
  
  
</head>
<body>
  
  <section data-bs-version="5.1" class="menu menu1 cid-uxIo30R6fm" once="menu" id="menu01-d">
	

	<nav class="navbar navbar-dropdown navbar-expand-lg">
		<div class="container">
			<div class="navbar-brand">
				
				<span class="navbar-caption-wrap"><a class="navbar-caption text-black text-primary display-4" href="index.html">Cameron Witton-Grove</a></span>
			</div>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbarSupportedContent" data-bs-target="#navbarSupportedContent" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
				<div class="hamburger">
					<span></span>
					<span></span>
					<span></span>
					<span></span>
				</div>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav nav-dropdown nav-right" data-app-modern-menu="true"><li class="nav-item"><a class="nav-link link text-black text-primary display-4" href="index.html">Home</a></li><li class="nav-item">
						<a class="nav-link link text-black text-primary display-4" href="about.html">About Me</a>
					</li>
					<li class="nav-item">
						<a class="nav-link link text-black text-primary display-4" href="https://baseballaheadinthecount.blogspot.com/" aria-expanded="false" target="_blank">Blog</a>
					</li>
					<li class="nav-item">
						<a class="nav-link link text-black text-primary display-4" href="contact.html">Contact</a>
					</li><li class="nav-item"><a class="nav-link link text-black text-primary display-4" href="projects.html">Hobby Projects</a></li></ul>
				
				
			</div>
		</div>
	</nav>
</section>

<section data-bs-version="5.1" class="start article4 cid-uxJVagn3TY" id="article04-e">
	

	
	

	<div class="container">
		<div class="row justify-content-center">
			<div class="col-12 col-md-12 col-lg-6 image-wrapper">
				<img class="w-100" src="assets/images/bus-board2.png" alt="Bus">
			</div>
			<div class="col-12 col-md-12 col-lg">
				<div class="text-wrapper align-left">
					<h1 class="mbr-section-title mbr-fonts-style mb-4 display-2"><strong>Dude, where's my bus?</strong></h1>
					<p class="mbr-text mbr-fonts-style mb-4 display-7">Testing the accuracy of TFL's bus arrival time projections with traffic awareness</p>
					
				</div>
			</div>
		</div>
	</div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVG5crjfB3" id="list02-2o">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">In this post I'll investigate how we can use bus arrival time estimates to produce full distributions, add awareness of traffic levels, and use these to plan journeys more effectively.<br><br>As a Londoner, especially one who lives in the South East, five miles from the nearest tube stop, I spend a lot of my time on buses. This gives me a lot of time to think about buses and how they fit into modern multi-modal route planning technology. When travelling somewhere by public transport, I'll check my phone and be given a variety of options to choose from. Bus, train, rail, tube, ferry, boat, cable car(!), etc... <br><br>It gets interesting when there are multiple options, featuring connections. Here the quickest route isn't always the best route. Taking the fastest route could lock you in to a tight connection with no reasonable alternatives if you miss it. A slower route with more slack could be optimal for avoiding the worst case scenario.<br><br>As an example, perhaps I finish work early and decide I want to catch a film in Peckham at 5pm. The fastest route is to get the SL4 bus into lovely Blackheath, followed by a train to Peckham. This option has a five minute connection between the bus and the train. In the heavy traffic between school pick ups and rush hour it is easy for the bus timetable to slip by more than five minutes. These trains only run once every 30 minutes, meaning that I'd be late for my movie with a five minute bus delay or more.<br><br>There is a slower route that involves travelling via Catford Bridge. This has a ten minute connection and the trains here are more regular. This means that there would be two more train options that would get me to my film on time, even if I missed the first one (which would be less likely anyway due to the longer connection window).<br><br>None of this would be obvious from the Google Maps screenshot below, where the shorter Blackheath route is clearly the favourite and the Catford Bridge option only shows up as the fourth one down.</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uVGbOxVWb6" id="image01-2q">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-9">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/bus-route-peckham2.png" alt="Bus Route">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVGgk385EC" id="list02-2r">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">I would love to have an option that gives me a range of arrival times and would suggest a route based on my specific risk tolerance while weighing up the full likelihood of journey outcomes. To do this we need to interrogate what lies beneath the route planning - bus arrival times.</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="start article4 cid-uxNIIhCrza" id="article04-k">
	

	
	

	<div class="container">
		<div class="row justify-content-center">
			<div class="col-12 col-md-12 col-lg-4 image-wrapper">
				<img class="w-100" src="assets/images/bus-example.png" alt="Bus Times">
			</div>
			<div class="col-12 col-md-12 col-lg">
				<div class="text-wrapper align-left">
					<h1 class="mbr-section-title mbr-fonts-style mb-4 display-5">Bus Arrival Predictions</h1>
					<p class="mbr-text mbr-fonts-style mb-4 display-7">Transport For London (TFL) provides locations and estimated arrival times for different modes of transport through their API which is open for the public to access. People have used this to create <a href="https://traintimes.org.uk/map/tube/" class="text-primary" target="_blank"><u>cool interactive boards with live tube locations</u></a>.<br><br>The image on the right shows a bus schedule on Google Maps for the 261 route at a single stop on the northbound route, with the green times being live estimates coming from buses that are currently en route.&nbsp;<br></p>
					
				</div>
			</div>
		</div>
	</div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVGmMS0Tlq" id="list02-2t">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12 active">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">These estimates come from information using the <a href="https://en.wikipedia.org/wiki/IBus_%28London%29" class="text-primary" target="_blank"><u>iBus system</u></a>, which uses GPS to narrow down the bus location. Interestingly, iBus can be used to give buses preferential treatment at traffic lights. I'd never heard of this before but this feature probably isn't advertised widely as motorists don't need any more reasons to dislike buses! The bus position information is passed to a central system that uses the data to predict the bus arrival time at future stops.<br><br>There isn't much that I can find online about the method for making these predictions. <a href="https://link.springer.com/article/10.1057/dddmp.2013.2" class="text-primary" target="_blank"><u>A 12-year old academic article</u></a> states "<em>The information on the time at which buses pass each stop is stored in such a way as to enable TfL to convert the distance each bus is from its next stops to a likely arrival time in minutes. Travel time between stops clearly varies by time of day, day of the week and between school terms and holidays. By relating the current time to bus speeds and times during equivalent historical time spots, TfL's predictive modelling systems can provide a much more accurate estimate of likely arrival times, given the current location of each bus. All this is undertaken in real time.</em>"&nbsp;<br><br>Route planning applications will use these values as inputs, but let's have a look and see how robust they are.&nbsp;<br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVGlFwW3Of" id="list02-2s">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            <h5 class="card-title mbr-fonts-style mb-3 display-5">
                                <strong>Data Collection - TfL</strong></h5>
                            <p class="card-text mbr-fonts-style mb-5 display-7">For my test I've focused on the 261 bus route northbound. I saved off predicted arrival times for every bus on this route at minute intervals during waking hours from Monday to Friday. The data looks something like the below:<br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uVGyeF3OiB" id="image01-2u">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-6">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/tfl-data.png" alt="TfL Data">
        </div>
        
        <p class="mbr-description mbr-fonts-style mb-0 align-center display-7">At each API call I took the vehicle ID, stop ID (naptan_id), the expected arrival time, and the time between now and the expected arrival time.</p>
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVGywRPQtR" id="list02-2v">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">
                                I couldn't find an easy way to get the <em>actual </em>arrival times of buses, so I used the point at which a specific vehicle + bus stop prediction left the dataset. When this was reached I labelled the arrival time as the last recorded estimate for that bus. Buses go round the route in a loop so the same vehicle will pass the same stop several times per day. Only matches that are close enough are recorded as arrivals.<br><br>By comparing the actual arrival time to the predicted arrival time, we can get the following distribution:</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uVJhP9VA4N" id="image01-2w">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-6">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/bus-arrival-histogram2.png" alt="Bus Arrival Error Histogram">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVJillOaS7" id="list02-2x">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12 active">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">
                                There is a strong peak at the predicted arrival time, more of the distribution lies to the right of 0 than the left, so buses are more likely to be late than early compared to their predicted arrival time. This makes sense, I would expect TfL to err on the side of predicting an arrival time that is too early relative to too late. You can always wait at the bus stop a while longer for a bus that is a little late, but missing a bus which left earlier than scheduled can be much more disruptive. I'm actually surprised at how much of the distribution is covered by buses leaving early but it does mean that the bus arrival times are decently calibrated.<br><br>I should note that this distribution shows the difference between a bus arrival time and its predicted arrival time while already on its route. Buses are almost never early relative to their scheduled times, and these arrival estimates from TfL will bake in any delays that have already occurred by the time the prediction is generated.<br><br>Some predictions will be easier than others. If a bus is close to its next stop then the prediction is likely to be accurate. If the bus is 20 minutes away then much more can change in the meantime. The boxplot below shows this effect.<br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uVJmiGexUX" id="image01-2y">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-7">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/tfl-boxplot.png" alt="Boxplot of arrival time error binned by time to arrival">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVJmGqKRGo" id="list02-2z">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">We can see that as the predictions get further into the future, the spread in error increases. Also, a small bias emerges where beyond 10 minutes into the future, the buses will on average arrive 80-90 seconds later than scheduled.<br><br>I could stop here, make some recalibration to the estimated bus arrival times and use the measured error bars to inform my journey planning, however I'm interested to understand what drives the variation in arrival times to see if I can make the predictions even more accurate.</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVJnkHLx16" id="list02-30">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            <h5 class="card-title mbr-fonts-style mb-3 display-5">
                                <strong>Measuring Traffic</strong></h5>
                            <p class="card-text mbr-fonts-style mb-5 display-7">
                                An unfortunate necessity in London is that for most of their journey, buses have to share the road with cars. This means that bus punctuality suffers when traffic builds up, there's only so much space to add bus lanes to alleviate this problem. I believe that traffic is what causes some of the uncertainty in bus arrival time.<br><br>Consider the journey below. The car route is forecast to take anywhere from 6 to 14 minutes depending on traffic, meanwhile the bus forecast is a stable 12 minutes. There are 9 stops on this bus route, and no bus lanes, so a reasonable bus forecast would be driving time + 3-5 minutes.&nbsp;<br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image02 cid-uVJGtB0lja" id="image02-31">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-8">
        <div class="row">
          <div class="col-12 col-lg-6">
            <div class="img-item">
              <img class="w-100 mb-4" src="assets/images/car-route1.png" alt="Car Route">
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="img-item">
              <img class="w-100 mb-4" src="assets/images/bus-route2.png" alt="Bus Route">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>


<section data-bs-version="5.1" class="content4 cid-uVJICU9LEP" id="list02-32">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">To measure the amount of traffic on the bus route we can use <a href="https://developers.google.com/maps/documentation/routes" class="text-primary" target="_blank"><u>Google's Routes API</u></a>. One can choose a pair of latitudes and longitudes, and Google will give you the current travel time between those two points, including the impact of traffic. Every 15 minutes I collected live traffic information between every set of consecutive stops on the 261 bus route.<br><br>Here's how the travel time between each stop on the 261 route looks<br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uVJMuBGnoT" id="image01-33">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-6">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/traffic-stops.png" alt="Traffic Boxplots">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVJMJCJvpB" id="list02-34">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">Some driving times are very stable, others vary significantly. The outlier at stop 15 isn't actually measuring the route the bus would take, cars are sent a long way around a one way system but the buses take a direct bus-only shortcut, so this part of the journey isn't being properly measured.<br><br>Some of the bus stops are ridiculously close to one another, with driving times of only 15-20 seconds, in several cases one bus stop is visible from the previous one. See <a href="https://www.mylondon.news/lifestyle/lifestyle-opinion/we-found-shortest-distance-between-24798478" class="text-primary" target="_blank"><u>this article</u></a>&nbsp;and&nbsp;<a href="https://www.michalpaszkiewicz.co.uk/blog/busdistributions/index.html" class="text-primary" target="_blank"><u>this article</u></a>&nbsp;for more discussion of London bus stop distances.<br><br>We can calculate a baseline driving time estimate between each pair of stops by taking the 30th percentile time from the full distribution. The variation vs the baseline is shown below.<br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uVJVXBDHOJ" id="image01-35">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-6">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/time-vs-baseline.png" alt="Traffic Baselines">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVP53LWts0" id="list02-37">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            <h5 class="card-title mbr-fonts-style mb-3 display-5">
                                <strong>Improving Arrival Predictions</strong></h5>
                            <p class="card-text mbr-fonts-style mb-5 display-7">
                                Next we can see how the traffic time vs the baseline helps us to understand what drives inaccuracies in bus arrival times. Traffic and TfL data were collected separately so we can join on the traffic information to the data on expected arrival times by doing a fuzzy join and only taking the traffic estimate that was made closest to the bus arrival time collection (a maximum of 7-8 minutes apart).<br><br>The graph below shows how the traffic time above baseline relates to the error in the TfL arrival time prediction. A 1:1 line is shown in red. The blue line is the line of best fit to this data sample. We can see that the relationship is very noisy - you're unlikely to get a very good model on this real world data, especially when much of the predictive "juice" will have been squeezed by TfL's existing algorithm for predicting arrival times!</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uVP5alh95M" id="image01-38">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-6">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/bus-traffic.png" alt="Traffic vs Prediction Error">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uVP5OWrfUm" id="list02-39">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">
                                There is some degree to where we can improve the predictions with traffic time differences. For each minute of traffic time above baseline, we can expect the prediction error to increase by 31 seconds. This is understandably a weak relationship, the R^2 of a linear model to predict arrival time error from traffic above baseline is <strong>0.13&nbsp;</strong>(correlation coefficient of <strong>0.37</strong>). The standard error in arrival time predictions reduces from <strong>206s </strong>to <strong>172s </strong>after using the additional traffic data.<br><br>If the distribution of arrival time prediction errors looked normal, then I could simply train a model for the average prediction error, followed by a model for the standard deviation, and this would give me the normal distribution of actual bus arrival times for a variety of scenarios. Unfortunately, as we saw above, this distribution looks clearly skewed and so we'll have to try something a bit different.</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uW0Cu2oANK" id="list02-3a">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            <h5 class="card-title mbr-fonts-style mb-3 display-5">
                                <strong>Producing Arrival Time Distributions</strong></h5>
                            <p class="card-text mbr-fonts-style mb-5 display-7">In my experience with data science, the majority of the time you only want to predict a point estimate of your target variable. In this case we need more than that, we need to predict the full realistic distribution of our target variable to understand the reasonable worst case scenarios for our bus arrival times.<br><br>There are many methods one can use to predict such a distribution. In some cases you want to have a fully parameterized shape, in others you may just want the best prediction of the Nth percentile outcome. In this case I'm going to do the latter, I do not need to know exactly how to parameterize the distribution of arrival time errors, and how those parameters vary with other variables. I only need to know the output shape of the distribution so I'll use something called quantile regression for this problem.<br><br>With regular regression, you get an estimate for the <em>mean</em>&nbsp;value of your target variable. With quantile regression, the objective function changes so that you can get an estimate for the Nth percentile outcome. For example if I want to predict the 10th percentile outcome, then the model will be optimized to produce outputs where 10% of the actual values are below the estimate and 90% of them are above the estimate.<br><br>Doing many quantile regressions at once gives you a sense of the spread in likely outcomes and can account for any weirdness in the distribution shape without needing it to be parameterized.<br><br>An alternative similar approach could be to use models to predict the likelihood of prediction error &gt; Q for a sequence of Q values. This would effectively produce the cumulative distribution function as a function of the input variables. This method is a bit more sensitive to how you bin your function as you have to deal with potential non-monotonicity in the predictions.<br><br>For my quantile regression I used a linear model formula that had three separate input variables. Traffic time above baseline, expected arrival time above baseline, and the expected arrival time itself. Both of the first two variables were interacted with&nbsp;expected arrival time.<br><br>The results below show the 5th through 95th percentile quantile regression predictions for a variety of cases, representing times when the bus is close or far and when there is lots or little traffic. In the graphs below, a far bus is 15 minutes away from the chosen stop and a close bus is within 2 minutes. High traffic is at least 5 minutes above baseline and low traffic is the same as baseline.</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uW0ZbzWee4" id="image01-3b">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-8">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/quantile-regression-numbers.png" alt="Quantile Regression output with numbers">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uW0ZthfCGI" id="list02-3d">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">It's easier to visualise these as box and whisker plots when the numbers get bunched up close together.</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uW0ZclVeGt" id="image01-3c">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-9">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/boxplots-quantile-regression.png" alt="Quantile Regression Boxplots">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uW0ZF5BMHY" id="list02-3e">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">We can see that the model is appropriately capturing the greater uncertainty for buses further away or buses in high-traffic situations. The skew is being captured as well, we can see that the right whisker is longer than the left whisker.<br><br>The widget below lets you tune the traffic and bus expected arrival times to see how the distribution changes in different situations.</p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<!-- Quantile Regression Widget (drop-in, namespaced, no theme overrides) -->
<div id="qrw-widget" class="mbr-fonts-style display-7" style="margin:1.5rem 0;">
  <style>
    /* Scope everything to #qrw-widget to avoid clashes with Bootstrap/Mobirise */
    #qrw-widget { color: inherit; font: inherit; 
      display: block;                         /* ensure block-level */
      width: min(100%, var(--qrw-max, 960px));/* cap on wide screens, fluid on small */
      margin-left: auto !important;           /* force centering even in flex/grid */
      margin-right: auto !important;
      align-self: center;                     /* if parent is flex */
      justify-self: center;                   /* if parent is grid */
      float: none;                            /* ignore any float rules */
    }
    #qrw-widget .qrw-card {
      border: 1px solid var(--bs-border-color, #e5e7eb);
      border-radius: 12px;
      background: transparent;
    }
    #qrw-widget .qrw-panel { position: relative; height: 420px; padding: 12px; }
    #qrw-widget .qrw-panel canvas { width: 100%; height: 100%; display: block; }
    #qrw-widget .qrw-controls { padding: 8px 12px 12px; }
    #qrw-widget .qrw-row {
      display: grid; grid-template-columns: 1fr 3fr 120px;
      gap: 12px; align-items: center; padding: 8px 0;
      border-top: 1px dashed var(--bs-border-color, #e5e7eb);
    }
    #qrw-widget .qrw-row:first-child { border-top: 0; }
    #qrw-widget .qrw-label { font-size: 0.95em; opacity: 0.9; margin: 0; }

    /* Subtle affordance for hoverable help */
    #qrw-widget .qrw-label[title]{
      text-decoration: underline dotted;
      text-underline-offset: .15em;
      cursor: help;
    }

    #qrw-widget .qrw-range { width: 100%; }
    #qrw-widget .qrw-num {
      width: 120px; max-width: 100%;
      padding: 8px; border: 1px solid var(--bs-border-color, #e5e7eb);
      border-radius: 8px; background: transparent; color: inherit; font: inherit;
    }
    #qrw-widget .qrw-actions {
      display:flex; justify-content:flex-end; padding: 8px 12px 12px;
      gap: 8px; flex-wrap: wrap;              /* spacing for multiple buttons */
    }
    #qrw-widget .qrw-btn {
      border: 1px solid var(--bs-border-color, #e5e7eb);
      background: transparent; color: inherit; font: inherit;
      border-radius: 10px; padding: 6px 12px; cursor: pointer;
    }
    @media (max-width: 640px){
      #qrw-widget .qrw-row { grid-template-columns: 1fr; }
      #qrw-widget .qrw-num { width: 100%; }
    }
  </style>

  <div class="qrw-card" role="region" aria-label="Quantile regression widget">
    <!-- CONTROLS FIRST -->
    <div class="qrw-controls" aria-label="Controls">
      <div class="qrw-row">
        <p class="qrw-label"
           title="Estimated time to drive between bus stops, above the baseline value defined as the 30th percentile of the distribution of measured driving times">
          Traffic above baseline (s)
        </p>
        <input id="qrw-traffic" class="qrw-range" type="range" min="0" max="1000" step="1" value="0" aria-label="Traffic above baseline slider">
        <input id="qrw-traffic-num" class="qrw-num" type="number" inputmode="numeric" min="0" max="1000" value="0" aria-label="Traffic above baseline number">
      </div>

      <div class="qrw-row">
        <p class="qrw-label"
           title="The baseline for expected time to arrival for a bus between stops. Defined as the 30th percentile value from the full distribution of TfL's expected arrival times">
          Arrival baseline time (s)
        </p>
        <input id="qrw-baseline" class="qrw-range" type="range" min="0" max="1800" step="1" value="900" aria-label="Arrival baseline time slider">
        <input id="qrw-baseline-num" class="qrw-num" type="number" inputmode="numeric" min="0" max="1800" value="900" aria-label="Arrival baseline time number">
      </div>

      <div class="qrw-row">
        <p class="qrw-label"
           title="The expected time to arrival of a specific bus. This can be greater than the baseline because TfL's algorithm adjusts the arrival time based on the time of day and other things">
          Time to station (s)
        </p>
        <input id="qrw-T" class="qrw-range" type="range" min="0" max="1800" step="1" value="900" aria-label="Time to station slider">
        <input id="qrw-T-num" class="qrw-num" type="number" inputmode="numeric" min="0" max="1800" value="900" aria-label="Time to station number">
      </div>

      <div class="qrw-actions" role="group" aria-label="Quick presets">
        <button id="qrw-low"   class="qrw-btn" type="button" title="Set traffic above baseline to 0s">Low Traffic</button>
        <button id="qrw-high"  class="qrw-btn" type="button" title="Set traffic above baseline to 300s">High Traffic</button>
        <button id="qrw-close" class="qrw-btn" type="button" title="Set baseline & time to station to 120s">Close Bus</button>
        <button id="qrw-far"   class="qrw-btn" type="button" title="Set baseline & time to station to 900s">Far Bus</button>
      </div>
    </div>

    <!-- CHART AFTER -->
    <div class="qrw-panel" aria-label="Chart">
      <canvas id="qrw-chart" aria-label="Quantile vs predicted value chart" role="img"></canvas>
    </div>
  </div>

  <script>
    (function(){
      'use strict';

      const ROOT = document.getElementById('qrw-widget');
      const $ = (sel) => ROOT.querySelector(sel);
      const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
      const toNum = (v) => Number.isFinite(Number(v)) ? Number(v) : 0;

      // Elements
      const traffic = $('#qrw-traffic'), trafficNum = $('#qrw-traffic-num');
      const baseline = $('#qrw-baseline'), baselineNum = $('#qrw-baseline-num');
      const T = $('#qrw-T'), Tnum = $('#qrw-T-num');
      const btnLow   = $('#qrw-low');
      const btnHigh  = $('#qrw-high');
      const btnClose = $('#qrw-close');
      const btnFar   = $('#qrw-far');
      const canvas = $('#qrw-chart');

      // Constants
      const TAUS = Array.from({length:19}, (_,i)=>Number((0.05+i*0.05).toFixed(2)));
      const COEFS = {
        "0.05": {"b0":-42.71925, "b1":0.2103119, "b2":-0.09962057, "b3":-0.1174645,  "b4":-0.00002923555, "b5":0.00007692915},
        "0.10": {"b0":-27.52915, "b1":0.2520285, "b2":-0.07656345, "b3":-0.1263686,  "b4":-0.00003367946, "b5":0.00007870521},
        "0.15": {"b0":-18.22348, "b1":0.2979397, "b2":-0.05861317, "b3":-0.1445287,  "b4":-0.00003842757, "b5":0.00007962759},
        "0.20": {"b0":-10.88219, "b1":0.3421984, "b2":-0.04088531, "b3":-0.1610206,  "b4":-0.00004905931, "b5":0.00007640494},
        "0.25": {"b0":-6.631507, "b1":0.3870328, "b2":-0.02265922, "b3":-0.1730117,  "b4":-0.0000699065,  "b5":0.00007013879},
        "0.30": {"b0":-5.639201, "b1":0.4635748, "b2":-0.004059487,"b3":-0.1872445, "b4":-0.0001090453, "b5":0.00006764477},
        "0.35": {"b0":-5.56704,  "b1":0.5567305, "b2":0.01334768,  "b3":-0.2064098,  "b4":-0.0001591149, "b5":0.00006924146},
        "0.40": {"b0":-5.537373, "b1":0.6374946, "b2":0.03168738,  "b3":-0.2307034,  "b4":-0.0001968355, "b5":0.00007294472},
        "0.45": {"b0":-4.778558, "b1":0.7112564, "b2":0.04898598,  "b3":-0.2552935,  "b4":-0.0002362265, "b5":0.00007800556},
        "0.50": {"b0":-3.681143, "b1":0.7832996, "b2":0.06600476,  "b3":-0.2816958,  "b4":-0.0002740022, "b5":0.00008508465},
        "0.55": {"b0":-2.0278321837,"b1":0.848324085, "b2":0.0821156553,"b3":-0.3094830934,"b4":-0.0003009162, "b5":0.0000938642},
        "0.60": {"b0":0.2115834824, "b1":0.9082023692, "b2":0.0979150657,"b3":-0.3389858927,"b4":-0.0003159551, "b5":0.0001046335},
        "0.65": {"b0":3.0157264543, "b1":0.9703886303, "b2":0.1149087775,"b3":-0.3685301903,"b4":-0.0003361916, "b5":0.0001124703},
        "0.70": {"b0":6.8590889937, "b1":1.0288134798, "b2":0.132970952,  "b3":-0.3951715556,"b4":-0.000355336,  "b5":0.0001172019},
        "0.75": {"b0":12.7842734592,"b1":1.0761616602, "b2":0.1509653494,"b3":-0.4203383279,"b4":-0.0003635853, "b5":0.0001225234},
        "0.80": {"b0":21.8792354609,"b1":1.1223892534, "b2":0.1686230368,"b3":-0.4278559277,"b4":-0.0003644579, "b5":0.0001227519},
        "0.85": {"b0":33.7452976834,"b1":1.1834821036, "b2":0.1892542369,"b3":-0.4324450556,"b4":-0.0003759316, "b5":0.0001232306},
        "0.90": {"b0":49.4622801208,"b1":1.2514561637, "b2":0.2182103436,"b3":-0.4219439991,"b4":-0.0003992269, "b5":0.0001097156},
        "0.95": {"b0":74.739,       "b1":1.362955,     "b2":0.2757007,   "b3":-0.4039426,   "b4":-0.0004818549, "b5":0.00008707917}
      };

      const predict = (dTraffic, dArrival, TT) =>
        TAUS.map(tau => {
          const k = tau.toFixed(2);
          const {b0,b1,b2,b3,b4,b5} = COEFS[k];
          return b0 + b1*dTraffic + b2*TT + b3*dArrival + b4*(dTraffic*TT) + b5*(TT*dArrival);
        });

      // Bind helpers (ranges & numbers stay in sync)
      function bindPair(rangeEl, numEl, def){
        const set = (v) => {
          const lo = toNum(rangeEl.min), hi = toNum(rangeEl.max);
          const vv = clamp(toNum(v), lo, hi);
          rangeEl.value = numEl.value = String(vv);
          update();
        };
        rangeEl.addEventListener('input', () => { numEl.value = rangeEl.value; update(); });
        numEl.addEventListener('input',  () => { rangeEl.value = numEl.value; update(); });
        numEl.addEventListener('change', () => set(numEl.value));   // snap back on commit
        numEl.addEventListener('dblclick', () => set(def));         // quick field reset
      }

      bindPair(traffic, trafficNum, 0);
      bindPair(baseline, baselineNum, 900);
      bindPair(T, Tnum, 900);

      // Helper: apply presets safely with two-pass update
      function applyPreset({traffic: tr, base: b, T: t}){
        // Relax interdependent limits before setting both values
        baseline.max = baselineNum.max = '1800';
        T.min = Tnum.min = '0';

        if (tr != null) { traffic.value = trafficNum.value = String(tr); }
        if (b  != null) { baseline.value = baselineNum.value = String(b); }
        if (t  != null) { T.value = Tnum.value = String(t); }

        // Run two updates so new limits take effect and values settle
        update();
        setTimeout(update, 0); // next tick
      }

      // Preset buttons
      btnLow.addEventListener('click',  () => applyPreset({traffic: 0}));
      btnHigh.addEventListener('click', () => applyPreset({traffic: 300}));
      btnClose.addEventListener('click',() => applyPreset({base: 120, T: 120}));
      btnFar.addEventListener('click',  () => applyPreset({base: 900, T: 900}));

      // Chart (load Chart.js v4 on-demand if needed)
      let chart = null;
      function ensureChart(){
        return new Promise((resolve) => {
          if (window.Chart && Number((Chart.version||'4').split('.')[0]) >= 3) return resolve();
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js';
          s.onload = resolve;
          s.onerror = resolve; // proceed without chart (controls still work)
          document.head.appendChild(s);
        });
      }

      function initChart(){
        if (!window.Chart || chart) return;
        chart = new Chart(canvas, {
          type: 'line',
          data: { datasets: [{
            label: 'Quantile vs predicted value',
            data: [],
            parsing: false,
            tension: 0.25,
            pointRadius: 3,
            borderWidth: 2
          }]},
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: false },
            scales: {
              x: { type: 'linear', title: { display: true, text: 'Bus Arrival Time Vs Prediction (s)' }, min: -300, max: 1200 },
              y: { type: 'linear', title: { display: true, text: 'Quantile (τ)' }, min: 0.05, max: 0.95, ticks: { stepSize: 0.05 } }
            },
            plugins: {
              tooltip: { callbacks: { label: (c) => `τ=${Number(c.raw.y).toFixed(2)} → ${Number(c.raw.x).toFixed(2)}` } },
              legend: { display: false }
            }
          }
        });
      }

      function update(){
        // Read & coarse clamp
        let dTraffic = clamp(toNum(traffic.value), 0, 1000);
        let base     = clamp(toNum(baseline.value), 0, 1800);
        let TT       = clamp(toNum(T.value),        0, 1800);

        // Hard limits (no auto-pushing the other control)
        baseline.max = baselineNum.max = String(TT);
        T.min        = Tnum.min        = String(base);

        // Enforce the limits for typed input
        if (base > TT) base = TT;
        if (TT < base) TT = base;

        // Write back (sync)
        traffic.value  = trafficNum.value  = String(dTraffic);
        baseline.value = baselineNum.value = String(base);
        T.value        = Tnum.value        = String(TT);

        // Derived Δarrival
        const dArrival = clamp(TT - base, 0, 1000);

        // Predictions → {x,y}
        const ys = predict(dTraffic, dArrival, TT);
        const points = ys.map((pv, i) => ({ x: pv, y: TAUS[i] }));

        if (chart) {
          chart.data.datasets[0].data = points;
          chart.update('none');
        }
      }

      // Start
      ensureChart().then(() => { initChart(); update(); });
      // In case Chart loads late on slow connections, keep data synced first:
      update();

      // Basic error logging (won’t interfere with your page)
      window.addEventListener('error', (e) => {
        if (ROOT && ROOT.contains(canvas)) {
          console.error('QR widget error:', e.error || e.message);
        }
      });
    })();
  </script>
</div>


<section data-bs-version="5.1" class="content4 cid-uWipBXnTpH" id="list02-3j">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">Let's use this model in a test case to understand how traffic affects our likelihood of making a specific connection and of expected travel time on a particular route. For this test case I'll use the trip to Peckham from the start of this post, aiming to arrive at the cinema before 5pm.
<br>
<br>On this route there is a theoretically shorter route via Blackheath with a 5-minute connection to a train that runs every half hour. There is an alternative route via Catford that has a wider connection window and more regular trains. For this example, I'll assume all bus routes have the same dependence to traffic and arrival time as the 261 that I trained my model on.
<br>
<br>With no traffic you'd be expected to make a 5-minute connection 90% of the time. In heavy traffic (+10 minutes) that connection would only be made half the time, even if TfL's journey length prediction was longer to compensate - something that would be very relevant for journey planning if that connection was important. The graph below shows how the chance of making a connection shifts with the traffic level. Contours of constant probability at 50%, 75% and 90% are shown as well.<br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uW3qteAMXa" id="image01-3f">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-6">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/traffic-make-connection-magma.png" alt="Connection likelihood vs traffic">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uW6XbIbOJ8" id="list02-3g">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            
                            <p class="card-text mbr-fonts-style mb-5 display-7">How does this affect our arrival time distribution? The distribution of arrival times is shown as a function of traffic below. We can see that the Catford route is much more robust to traffic than the Blackheath route. The Blackheath route (blue) arrives earlier on average than the Catford route (red) for traffic &lt;= 600s, but the downside risk of the much later arrival time when missing that first train is larger for the Blackheath route.<br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image01 cid-uW770G0rKJ" id="image01-3h">
  

  
  

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-6">
        <div class="image-wrapper mb-4">
          <img class="w-100" src="assets/images/blackheath-catford-routes2.png" alt="Blackheath route vs Catford">
        </div>
        
        
      </div>
    </div>
  </div>
</section>

<section data-bs-version="5.1" class="content4 cid-uW77nuHdVP" id="list02-3i">
    

    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="title col-md-12 mb-5">
                    
                    
                </div>
                <div class="item features-without-image col-12">
                    <div class="item-wrapper">
                        <div class="card-box align-left">
                            <h5 class="card-title mbr-fonts-style mb-3 display-5">
                                <strong>Summary</strong></h5>
                            <p class="card-text mbr-fonts-style mb-5 display-7">Thanks to the generosity of TfL's open data (and Google's free API trial) I've been able to thoroughly investigate the distributions of bus arrival times, along with their sensitivity to traffic along the route. It's possible to make slight improvements to TfL's arrival predictions with the integration of traffic information, however these are unlikely to be substantial enough to justify the cost of regularly querying traffic information.<br><br>This data has been used to produce realistic arrival time distributions which are more useful for journey planning than a point estimate. We've seen an example of how a slower route can be much more robust to bus lateness than a faster route. If I was more of a software engineer, I'd be working on a way to scale this and give myself route recommendations that can account for the level of risk in a particular choice. Perhaps in the future I'll design a small interactive example of how this could work for limited routes.<br><br><br></p>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
<script src="https://utteranc.es/client.js"
        repo="cejgrove/cejgrove.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</section><script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>  <script src="assets/smoothscroll/smooth-scroll.js"></script>  <script src="assets/ytplayer/index.js"></script>  <script src="assets/dropdown/js/navbar-dropdown.js"></script>  <script src="assets/theme/js/script.js"></script>  
  
  
</body>
</html>